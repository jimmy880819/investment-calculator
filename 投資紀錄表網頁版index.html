<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼æŠ•è³‡çµ„åˆè¨ˆç®—å™¨ (æ”¯æ´è‚¡ç¥¨/åŒ¯ç‡ - æœ€çµ‚ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* CSS æ¨£å¼ (ä¿®æ­£äº† border-radius çš„ typoï¼Œä¸¦æ–°å¢åŒ¯ç‡å€å¡Šæ¨£å¼) */
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; }
        h2 { color: #333; border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-top: 30px; }
        .input-section { display: flex; gap: 20px; margin-bottom: 20px; }
        .form-container { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); flex: 1; }
        .form-container input { width: calc(100% - 10px); padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-container button { padding: 8px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; margin-top: 5px; }
        .form-container button.delete-btn { background-color: #dc3545; padding: 5px 8px; font-size: 12px; margin-left: 5px;}
        .form-container button:hover { background-color: #45a049; }
        
        .transaction-table-wrapper { max-height: 250px; overflow-y: scroll; margin-top: 15px; }
        .transaction-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .transaction-table th, .transaction-table td { border: 1px solid #ddd; padding: 8px; text-align: right; }
        .transaction-table th { background-color: #f0f0f0; text-align: center; }
        .transaction-table td:nth-child(1) { text-align: left; }
        
        .dashboard { display: flex; justify-content: space-around; background-color: #e0e0e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .dashboard-item { text-align: center; font-size: 16px; font-weight: bold; }
        .dashboard-value { font-size: 24px; margin-top: 5px; }
        .report-table { width: 100%; border-collapse: collapse; background-color: #fff; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-top: 15px; }
        .report-table th, .report-table td { border: 1px solid #ddd; padding: 10px; text-align: right; }
        .report-table th { background-color: #4CAF50; color: white; text-align: center; }
        .text-left { text-align: left; }
        .positive { color: green; }
        .negative { color: red; }

        #clearDataBtn { background-color: #6c757d; margin-top: 10px; }
        #clearDataBtn:hover { background-color: #5a6268; }
        
        #priceUpdateContainer button { margin-top: 5px; }
        #cryptoFetchBtn { background-color: #ff8c00; }
        #cryptoFetchBtn:hover { background-color: #e07b00; }
        #stockFetchBtn { background-color: #17a2b8; }
        #stockFetchBtn:hover { background-color: #138496; }

        #exchangeRateContainer { background-color: #f7f7f7; padding: 10px; border-radius: 4px; margin-bottom: 10px; }

        /* åœ–è¡¨å€å¡Šæ¨£å¼ */
        .chart-section { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 20px; }
        .chart-container { width: 32%; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .chart-container h4 { text-align: center; margin-top: 0; }
    </style>
</head>
<body>

    <h1>ğŸ’° äº’å‹•å¼æŠ•è³‡çµ„åˆè¨ˆç®—å™¨ (æ”¯æ´è‚¡ç¥¨/åŒ¯ç‡)</h1>

    <h2>ğŸ“¥ äº¤æ˜“è¼¸å…¥å€</h2>
    <div class="input-section">
        
        <div class="form-container">
            <h3>ğŸ›’ è²·å…¥ç´€éŒ„ (Purchase)</h3>
            <p style="color:red; font-size: 12px; font-weight: bold;">âš ï¸ è²·å…¥åƒ¹æ ¼è«‹ä¸€å¾‹æ›ç®—ç‚º TWD å¾Œè¼¸å…¥ï¼</p>
            <input type="text" id="buyTicker" placeholder="ä»£è™Ÿ (ä¾‹å¦‚: 2330, NVDA, ADA)" value="ADA">
            <input type="number" id="buyPrice" placeholder="åƒ¹æ ¼ (TWD/å–®ä½)" step="0.0001">
            <input type="number" id="buyQty" placeholder="æ•¸é‡" step="0.0001">
            <button onclick="addBuy()">æ–°å¢è²·å…¥ç´€éŒ„</button>
            
            <div id="buyListWrapper" class="transaction-table-wrapper">
                <p>ç›®å‰æ²’æœ‰è²·å…¥ç´€éŒ„</p>
            </div>
        </div>

        <div class="form-container">
            <h3>ğŸ’¸ è³£å‡ºç´€éŒ„ (Sale)</h3>
            <p style="color:red; font-size: 12px; font-weight: bold;">âš ï¸ è³£å‡ºåƒ¹æ ¼è«‹ä¸€å¾‹æ›ç®—ç‚º TWD å¾Œè¼¸å…¥ï¼</p>
            <input type="text" id="sellTicker" placeholder="ä»£è™Ÿ (ä¾‹å¦‚: 2330, NVDA, ADA)" value="ADA">
            <input type="number" id="sellPrice" placeholder="åƒ¹æ ¼ (TWD/å–®ä½)" step="0.0001">
            <input type="number" id="sellQty" placeholder="æ•¸é‡" step="0.0001">
            <button onclick="addSell()">æ–°å¢è³£å‡ºç´€éŒ„</button>
            
            <div id="sellListWrapper" class="transaction-table-wrapper">
                <p>ç›®å‰æ²’æœ‰è³£å‡ºç´€éŒ„</p>
            </div>
        </div>
        
        <div class="form-container">
            <h3>ğŸ“ˆ å³æ™‚å¸‚åƒ¹èˆ‡åŒ¯ç‡</h3>

            <div id="exchangeRateContainer">
                <p style="font-weight: bold;">ğŸ’µ USD å…Œ TWD åŒ¯ç‡ (æ‰‹å‹•è¼¸å…¥)</p>
                <input type="number" id="exchangeRateInput" placeholder="ä¾‹å¦‚: 32.50" step="0.0001" style="width: calc(100% - 10px);">
                <button onclick="updateExchangeRate()" style="background-color: #6c757d; width: 100%;">æ›´æ–°åŒ¯ç‡ä¸¦é‡æ–°è¨ˆç®—</button>
            </div>

            <p>ç¾è‚¡è«‹è¼¸å…¥ USD åƒ¹æ ¼ï¼Œå°è‚¡/åŠ å¯†è²¨å¹£è«‹è¼¸å…¥ TWD åƒ¹æ ¼ã€‚</p>
            <textarea id="currentPriceInput" rows="4" style="width: 100%;"></textarea>
            
            <div id="priceUpdateContainer">
                <button id="cryptoFetchBtn" onclick="fetchCryptoPricesFromAPI()" style="width: 100%;">âš¡ è‡ªå‹•æŠ“å–åŠ å¯†è²¨å¹£å¸‚åƒ¹ (TWD)</button>
                <button id="stockFetchBtn" onclick="fetchStockPricesFromAPI()" style="width: 100%;">ğŸŒ å˜—è©¦æŠ“å–è‚¡ç¥¨åƒ¹æ ¼</button>
                <p style="font-size: 12px; color: red;">(è‚¡ç¥¨æŠ“å–éœ€æ­é…æ‚¨è‡ªæ¶çš„å¾Œç«¯æœå‹™)</p>
                <button onclick="updatePricesAndRecalculate()" style="background-color: #007bff; width: 100%;">æ‰‹å‹•æ›´æ–°å¸‚åƒ¹èˆ‡è¨ˆç®—</button>
                <button id="clearDataBtn" onclick="clearAllData()">â›” æ¸…é™¤æ‰€æœ‰å·²å„²å­˜æ•¸æ“š</button>
            </div>
        </div>
    </div>
    
    <h2>ğŸ“Š æŠ•è³‡ç¸½è¦½ (TWD)</h2>
    <div id="dashboard-output" class="dashboard">è¼‰å…¥ä¸­...</div>

    <h2>ğŸ“ˆ å¯è¦–åŒ–åˆ†æ</h2>
    <div class="chart-section">
        <div class="chart-container">
            <h4>åº«å­˜å¸‚å ´åƒ¹å€¼ä½”æ¯” (åœ“é¤…åœ–)</h4>
            <canvas id="holdingsPieChart"></canvas>
        </div>
        <div class="chart-container">
            <h4>å–®ä¸€è³‡ç”¢æç›Šæ¯”è¼ƒ (æŸ±ç‹€åœ–)</h4>
            <canvas id="plBarChart"></canvas>
        </div>
        <div class="chart-container">
            <h4>è³‡ç”¢ ROI è¡¨ç¾ (%)</h4>
            <canvas id="roiBarChart"></canvas>
        </div>
    </div>

    <h2>ğŸ“œ å€‹åˆ¥è³‡ç”¢ç›ˆè™§è©³æƒ… (TWD)</h2>
    <table id="portfolio-table" class="report-table">
        <thead>
            <tr>
                <th class="text-left">ä»£è™Ÿ</th>
                <th>å¹£ç¨®/è‚¡åˆ¥</th>
                <th>ç›®å‰å¸‚åƒ¹ (TWD)</th>
                <th>ç¸½è³¼å…¥æˆæœ¬ (TWD)</th>
                <th>å¹³å‡è³¼å…¥åƒ¹ (TWD)</th>
                <th>ç¸½å‡ºå”®é‡‘é¡ (TWD)</th>
                <th>å·²å¯¦ç¾æç›Š (TWD)</th>
                <th>å‰©é¤˜æ•¸é‡</th>
                <th>æœªå¯¦ç¾æç›Š (TWD)</th>
                <th>ç¸½æç›Š (TWD) (æœªå¯¦ç¾ + å·²å¯¦ç¾)</th>
                <th>ç¸½ ROI (%)</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="11" style="text-align: center;">å°šç„¡æ•¸æ“š</td></tr>
        </tbody>
    </table>

    <script>
        // --- 1. å…¨åŸŸè®Šæ•¸èˆ‡è³‡ç”¢/API ID æ˜ å°„ ---
        let buyData = [];
        let sellData = [];
        let currentPrices = {}; 
        let currentCharts = {};
        let exchangeRateUSDToTWD = 32.0; // é è¨­åŒ¯ç‡

        // **US Stock Ticker åˆ—è¡¨** (è«‹æ‰‹å‹•ç¶­è­·æ‚¨çš„ç¾è‚¡æ¸…å–®)
        const US_TICKERS = new Set(['NVDA', 'AAPL', 'MSFT', 'GOOG', 'TSLA', 'AMZN']); 
        // **CoinGecko ID æ˜ å°„è¡¨** (ç”¨æ–¼åŠ å¯†è²¨å¹£è‡ªå‹•æŠ“åƒ¹)
        const COIN_ID_MAP = {
            'ADA': 'cardano', 'ETH': 'ethereum', 'BTC': 'bitcoin', 'SOL': 'solana',
            'DOT': 'polkadot', 'XRP': 'ripple', 'DOGE': 'dogecoin', 'UNI': 'uniswap',
        };

        // --- 2. æ ¸å¿ƒå·¥å…·å‡½æ•¸ ---

        /** æª¢æŸ¥æ˜¯å¦ç‚ºç¾è‚¡ (å’Œéœ€è¦ USD è½‰æ›çš„è³‡ç”¢) */
        function isUSStock(ticker) { return US_TICKERS.has(ticker.toUpperCase()); }
        /** æª¢æŸ¥æ˜¯å¦ç‚ºåŠ å¯†è²¨å¹£ */
        function isCrypto(ticker) { return COIN_ID_MAP.hasOwnProperty(ticker.toUpperCase()); }
        /** åˆ¤æ–·è³‡ç”¢é¡å‹ä¸¦è¿”å›æ¨™ç±¤ */
        function getAssetTypeLabel(ticker) {
            if (isUSStock(ticker)) return 'ç¾è‚¡/USD è³‡ç”¢';
            if (isCrypto(ticker)) return 'åŠ å¯†è²¨å¹£';
            return 'å°è‚¡/TWD è³‡ç”¢';
        }

        function formatCurrency(value, decimal = 2) { 
            return value.toFixed(decimal).replace(/\B(?=(\d{3})+(?!\d))/g, ','); 
        }
        function formatPL(value) {
            const className = value >= 0 ? 'positive' : 'negative';
            return `<span class="${className}">${formatCurrency(value)}</span>`;
        }
        function getUniqueTickers() {
            const tickers = new Set();
            buyData.forEach(item => tickers.add(item.ticker));
            sellData.forEach(item => tickers.add(item.ticker));
            return Array.from(tickers).sort();
        }
        
        // --- 3. åŒ¯ç‡èˆ‡åƒ¹æ ¼æ›´æ–°é‚è¼¯ ---

        /** æ›´æ–°åŒ¯ç‡ä¸¦è§¸ç™¼é‡æ–°è¨ˆç®— */
        function updateExchangeRate() {
            const rateInput = document.getElementById('exchangeRateInput');
            const newRate = parseFloat(rateInput.value);
            
            // åªæœ‰ç•¶è¼¸å…¥æ¡†æœ‰å€¼ä¸”ç‚ºç„¡æ•ˆæ•¸å­—æ™‚æ‰æç¤º
            if (rateInput.value.trim() !== '' && (isNaN(newRate) || newRate <= 0)) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ USD å…Œ TWD åŒ¯ç‡ã€‚');
                return;
            }
            // å¦‚æœè¼¸å…¥æ¡†ç‚ºç©ºï¼Œä¸é€²è¡Œæ“ä½œï¼Œä¿æŒèˆŠå€¼
            if (rateInput.value.trim() !== '') {
                 exchangeRateUSDToTWD = newRate;
            }

            saveData(); 
            renderReport();
        }

        /** æ›´æ–°å¸‚åƒ¹è¼¸å…¥åˆ—è¡¨ï¼Œåªé¡¯ç¤ºåº«å­˜ä¸ç‚ºé›¶çš„é …ç›® */
        function updatePriceInputList() {
            const { report } = calculatePortfolio(); 
            const holdingsReport = report.filter(p => p.remainingQty > 0);

            const priceText = holdingsReport.map(p => {
                // è®€å– currentPrices ä¸­å„²å­˜çš„åŸå§‹è¼¸å…¥åƒ¹æ ¼
                const price = currentPrices[p.ticker] !== undefined ? currentPrices[p.ticker] : 0.00; 
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºç¾è‚¡ï¼Œæä¾›è¼¸å…¥æç¤º
                const currencyNote = isUSStock(p.ticker) ? ' (USD)' : '';
                return `${p.ticker}: ${price.toFixed(4)}${currencyNote}`; 
            }).join('\n');
            
            document.getElementById('currentPriceInput').value = priceText || 'è«‹è¼¸å…¥äº¤æ˜“ç´€éŒ„ä»¥è‡ªå‹•æ–°å¢å¹£ç¨®';
        }

        /** æ‰‹å‹•æ›´æ–°å¸‚åƒ¹èˆ‡è¨ˆç®— (åŒæ™‚è®€å–åŒ¯ç‡) */
        function updatePricesAndRecalculate() {
            // 1. ç¢ºä¿åŒ¯ç‡è¢«è®€å–/æ›´æ–°
            updateExchangeRate(); 
            
            // 2. è§£æå¸‚åƒ¹
            const input = document.getElementById('currentPriceInput').value;
            const newPrices = {};
            input.split('\n').forEach(line => {
                const parts = line.split(':').map(p => p.trim());
                if (parts.length >= 2 && parts[0] && !isNaN(parseFloat(parts[1]))) {
                    newPrices[parts[0].toUpperCase()] = parseFloat(parts[1]);
                }
            });
            currentPrices = newPrices;

            saveData();
            renderReport();
        }
        
        // --- 4. è‡ªå‹•æŠ“å–åŠŸèƒ½ ---
        
        /** è‡ªå‹•æŠ“å–åŠ å¯†è²¨å¹£å¸‚åƒ¹ (ä½¿ç”¨ CoinGecko API) */
        async function fetchCryptoPricesFromAPI() {
            const { report } = calculatePortfolio(); 
            const uniqueTickers = report.filter(p => p.remainingQty > 0 && isCrypto(p.ticker)).map(p => p.ticker);

            if (uniqueTickers.length === 0) { alert('æ²’æœ‰æ‰¾åˆ°å¯è‡ªå‹•æŠ“åƒ¹çš„åŠ å¯†è²¨å¹£å¹£ç¨®ï¼Œæˆ–ç›¸é—œå¹£ç¨®å·²ç„¡åº«å­˜ã€‚'); return; }

            const coinIds = uniqueTickers.map(ticker => COIN_ID_MAP[ticker]).filter(id => id);
            if (coinIds.length === 0) { alert('éŒ¯èª¤ï¼šæ²’æœ‰æ‰¾åˆ°å°æ‡‰çš„ API å¹£ç¨® IDã€‚'); return; }
            const idsString = coinIds.join(',');
            // ä½¿ç”¨ CoinGecko API æŠ“å– TWD åƒ¹æ ¼
            const url = `https://api.coingecko.com/api/v3/simple/price?ids=${idsString}&vs_currencies=twd`; 

            try {
                document.getElementById('cryptoFetchBtn').textContent = 'è®€å–ä¸­...';
                document.getElementById('cryptoFetchBtn').disabled = true;

                const response = await fetch(url);
                if (!response.ok) throw new Error(`API response status: ${response.status}`);
                const data = await response.json();

                let pricesUpdated = false;
                for (const ticker of uniqueTickers) {
                    const coinId = COIN_ID_MAP[ticker];
                    if (data[coinId] && data[coinId].twd) {
                        const newPrice = data[coinId].twd;
                        if (currentPrices[ticker] !== newPrice) {
                            currentPrices[ticker] = newPrice;
                            pricesUpdated = true;
                        }
                    }
                }
                
                if (pricesUpdated) {
                    updatePriceInputList(); 
                    saveData();
                    renderReport();
                    alert(`âœ… æˆåŠŸæŠ“å– ${coinIds.length} å€‹åŠ å¯†è²¨å¹£æœ€æ–°åƒ¹æ ¼ï¼`);
                } else {
                    alert('åŠ å¯†è²¨å¹£å¸‚åƒ¹å·²æ˜¯æœ€æ–°ï¼Œæˆ– API æœªè¿”å›æ–°æ•¸æ“šã€‚');
                }

            } catch (error) {
                console.error("API æŠ“å–å¤±æ•—:", error);
                alert(`âŒ è‡ªå‹•æŠ“å–å¤±æ•—ï¼åŸå› ï¼š${error.message} (CORS é™åˆ¶ï¼Œè«‹å˜—è©¦æ‰‹å‹•è¼¸å…¥ã€‚)`);
            } finally {
                 document.getElementById('cryptoFetchBtn').textContent = 'âš¡ è‡ªå‹•æŠ“å–åŠ å¯†è²¨å¹£å¸‚åƒ¹ (TWD)';
                 document.getElementById('cryptoFetchBtn').disabled = false;
            }
        }
        
        /** å˜—è©¦æŠ“å–è‚¡ç¥¨åƒ¹æ ¼ (éœ€è¦å¾Œç«¯æœå‹™æ”¯æ´çš„ç¯„æœ¬) */
        async function fetchStockPricesFromAPI() {
            // **é‡è¦è¨­å®šï¼šè«‹å°‡æ­¤æ›¿æ›ç‚ºæ‚¨å¾Œç«¯ä¼ºæœå™¨è™•ç† API è«‹æ±‚çš„ç¶²å€**
            const API_ENDPOINT = 'YOUR_STOCK_API_ENDPOINT'; 
            
            // 1. å…ˆè¨ˆç®—å‡ºç›®å‰æŒæœ‰çš„è‚¡ç¥¨ä»£è™Ÿ
            const { report } = calculatePortfolio(); 
            const stockTickers = report
                .filter(p => p.remainingQty > 0 && !isCrypto(p.ticker)) // æ’é™¤å·²è³£å…‰å’ŒåŠ å¯†è²¨å¹£
                .map(p => p.ticker);

            if (stockTickers.length === 0) { 
                alert('ç›®å‰æ²’æœ‰éœ€è¦æ›´æ–°åƒ¹æ ¼çš„è‚¡ç¥¨/å°è‚¡ã€‚'); 
                return; 
            }
            
            if (API_ENDPOINT === 'YOUR_STOCK_API_ENDPOINT') {
                alert('ğŸš« éŒ¯èª¤ï¼šè«‹å…ˆå°‡ JavaScript ä»£ç¢¼ä¸­çš„ API_ENDPOINT æ›¿æ›ç‚ºæ‚¨å¯¦éš›éƒ¨ç½²çš„å¾Œç«¯æœå‹™ç¶²å€ï¼');
                return;
            }

            try {
                document.getElementById('stockFetchBtn').textContent = 'è®€å–ä¸­...';
                document.getElementById('stockFetchBtn').disabled = true;
                
                // 2. å‘¼å«æ‚¨çš„å¾Œç«¯ APIï¼Œå‚³é€éœ€è¦æŸ¥è©¢çš„è‚¡ç¥¨æ¸…å–®
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // å‚³é€è‚¡ç¥¨æ¸…å–®èˆ‡ç•¶å‰åŒ¯ç‡çµ¦å¾Œç«¯è™•ç†
                    body: JSON.stringify({ tickers: stockTickers, rate: exchangeRateUSDToTWD }) 
                });

                if (!response.ok) throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                const data = await response.json(); 
                
                let pricesUpdated = false;
                for (const ticker in data) {
                    const price = parseFloat(data[ticker]);
                    if (!isNaN(price) && price > 0) {
                        currentPrices[ticker.toUpperCase()] = price;
                        pricesUpdated = true;
                    }
                }
                
                if (pricesUpdated) {
                    updatePriceInputList(); 
                    saveData();
                    renderReport();
                    alert(`âœ… æˆåŠŸæŠ“å– ${Object.keys(data).length} å€‹è‚¡ç¥¨æœ€æ–°åƒ¹æ ¼ï¼`);
                } else {
                    alert('è‚¡ç¥¨å¸‚åƒ¹å·²æ˜¯æœ€æ–°ï¼Œæˆ–å¾Œç«¯ API æœªè¿”å›åƒ¹æ ¼ã€‚');
                }

            } catch (error) {
                console.error("è‚¡ç¥¨ API æŠ“å–å¤±æ•—:", error);
                alert(`âŒ è‚¡ç¥¨è‡ªå‹•æŠ“å–å¤±æ•—ï¼åŸå› ï¼š${error.message} (è«‹ç¢ºèªæ‚¨çš„å¾Œç«¯æœå‹™æ˜¯å¦æ­£å¸¸é‹ä½œã€‚)`);
            } finally {
                 document.getElementById('stockFetchBtn').textContent = 'ğŸŒ å˜—è©¦æŠ“å–è‚¡ç¥¨åƒ¹æ ¼';
                 document.getElementById('stockFetchBtn').disabled = false;
            }
        }


        // --- 5. å„²å­˜èˆ‡è¼‰å…¥å‡½æ•¸ ---
        function saveData() {
            try {
                localStorage.setItem('portfolio_buy_data', JSON.stringify(buyData));
                localStorage.setItem('portfolio_sell_data', JSON.stringify(sellData));
                localStorage.setItem('portfolio_prices', JSON.stringify(currentPrices));
                localStorage.setItem('exchange_rate_usd_twd', exchangeRateUSDToTWD);
            } catch (e) { console.error("ç„¡æ³•å„²å­˜æ•¸æ“šåˆ° Local Storage:", e); }
        }
        function loadData() {
            try {
                const storedBuys = localStorage.getItem('portfolio_buy_data');
                const storedSells = localStorage.getItem('portfolio_sell_data');
                const storedPrices = localStorage.getItem('portfolio_prices');
                const storedRate = localStorage.getItem('exchange_rate_usd_twd');
                
                if (storedBuys) buyData = JSON.parse(storedBuys);
                if (storedSells) sellData = JSON.parse(storedSells);
                if (storedPrices) currentPrices = JSON.parse(storedPrices);
                if (storedRate) exchangeRateUSDToTWD = parseFloat(storedRate);

            } catch (e) { console.error("è¼‰å…¥æ•¸æ“šå¤±æ•—:", e); }
        }
        function clearAllData() {
             if (confirm("è­¦å‘Šï¼šæ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²å„²å­˜çš„äº¤æ˜“ç´€éŒ„ã€å¸‚åƒ¹å’ŒåŒ¯ç‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
                localStorage.clear(); 
                buyData = []; sellData = []; currentPrices = {}; exchangeRateUSDToTWD = 32.0;
                // é‡è¨­ UI
                document.getElementById('exchangeRateInput').value = exchangeRateUSDToTWD;
                updatePriceInputList(); 
                renderTransactionList(); 
                renderReport();
                alert("æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤ï¼Œç¨‹å¼å°‡é‡æ–°é–‹å§‹ã€‚");
            }
        }

        // --- 6. äº¤æ˜“è™•ç†èˆ‡åˆ—è¡¨æ¸²æŸ“ (å·²å®Œæ•´ä¿®å¾©) ---
        function renderTransactionList() {
            // è²·å…¥åˆ—è¡¨
            const buyTable = buyData.length > 0 ? `<table class="transaction-table"><thead><tr><th>æ—¥æœŸ</th><th>ä»£è™Ÿ</th><th>åƒ¹æ ¼(TWD)</th><th>æ•¸é‡</th><th>ç¸½æˆæœ¬</th><th>åˆªé™¤</th></tr></thead><tbody>${buyData.map((item, index) => `<tr><td class="text-left">${item.date}</td><td>${item.ticker}</td><td>${formatCurrency(item.price)}</td><td>${item.qty.toFixed(4)}</td><td>${formatCurrency(item.price * item.qty)}</td><td><button class="delete-btn" onclick="deleteBuy(${index})">X</button></td></tr>`).join('')}</tbody></table>` : '<p>ç›®å‰æ²’æœ‰è²·å…¥ç´€éŒ„</p>';
            document.getElementById('buyListWrapper').innerHTML = buyTable;

            // è³£å‡ºåˆ—è¡¨
            const sellTable = sellData.length > 0 ? `<table class="transaction-table"><thead><tr><th>æ—¥æœŸ</th><th>ä»£è™Ÿ</th><th>åƒ¹æ ¼(TWD)</th><th>æ•¸é‡</th><th>ç¸½æ”¶å…¥</th><th>åˆªé™¤</th></tr></thead><tbody>${sellData.map((item, index) => `<tr><td class="text-left">${item.date}</td><td>${item.ticker}</td><td>${formatCurrency(item.price)}</td><td>${item.qty.toFixed(4)}</td><td>${formatCurrency(item.price * item.qty)}</td><td><button class="delete-btn" onclick="deleteSell(${index})">X</button></td></tr>`).join('')}</tbody></table>` : '<p>ç›®å‰æ²’æœ‰è³£å‡ºç´€éŒ„</p>';
            document.getElementById('sellListWrapper').innerHTML = sellTable;
        }

        function addBuy() {
            const ticker = document.getElementById('buyTicker').value.toUpperCase().trim();
            const price = parseFloat(document.getElementById('buyPrice').value);
            const qty = parseFloat(document.getElementById('buyQty').value);
            const date = new Date().toLocaleString(); 
            
            if (!ticker || isNaN(price) || isNaN(qty) || price <= 0 || qty <= 0) { 
                alert('è«‹ç¢ºèªæ‰€æœ‰æ¬„ä½ (ä»£è™Ÿ, åƒ¹æ ¼, æ•¸é‡) éƒ½å·²å¡«å…¥æœ‰æ•ˆçš„æ­£æ•¸ï¼'); 
                return; 
            }
            
            buyData.push({ date, ticker, price, qty });
            
            document.getElementById('buyPrice').value = '';
            document.getElementById('buyQty').value = '';
            
            updatePriceInputList(); 
            saveData();
            renderTransactionList();
            renderReport();
        }
        function deleteBuy(index) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç¬¬ ${index + 1} ç­†è²·å…¥ç´€éŒ„å—ï¼Ÿ`)) {
                buyData.splice(index, 1);
                updatePriceInputList(); saveData(); renderTransactionList(); renderReport();
            }
        }
        function addSell() {
            const ticker = document.getElementById('sellTicker').value.toUpperCase().trim();
            const price = parseFloat(document.getElementById('sellPrice').value);
            const qty = parseFloat(document.getElementById('sellQty').value);
            const date = new Date().toLocaleString(); 
            
            if (!ticker || isNaN(price) || isNaN(qty) || price <= 0 || qty <= 0) { 
                alert('è«‹ç¢ºèªæ‰€æœ‰æ¬„ä½ (ä»£è™Ÿ, åƒ¹æ ¼, æ•¸é‡) éƒ½å·²å¡«å…¥æœ‰æ•ˆçš„æ­£æ•¸ï¼'); 
                return; 
            }
            
            sellData.push({ date, ticker, price, qty });
            
            document.getElementById('sellPrice').value = '';
            document.getElementById('sellQty').value = '';
            
            updatePriceInputList(); 
            saveData();
            renderTransactionList();
            renderReport();
        }
        function deleteSell(index) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç¬¬ ${index + 1} ç­†è³£å‡ºç´€éŒ„å—ï¼Ÿ`)) {
                sellData.splice(index, 1);
                updatePriceInputList(); saveData(); renderTransactionList(); renderReport();
            }
        }


        // --- 7. æ ¸å¿ƒè¨ˆç®—é‚è¼¯ (å«ç¾è‚¡æ›ç®—) ---
        function calculatePortfolio() {
            const portfolio = {};
            let totalBuyCost = 0;
            let totalSellRevenue = 0;
            
            buyData.forEach(item => {
                const cost = item.price * item.qty;
                totalBuyCost += cost;
                if (!portfolio[item.ticker]) {
                    portfolio[item.ticker] = { totalBuyQty: 0, totalBuyCost: 0, totalSellQty: 0, totalSellRevenue: 0, realizedPL: 0 };
                }
                portfolio[item.ticker].totalBuyQty += item.qty;
                portfolio[item.ticker].totalBuyCost += cost;
            });
            Object.values(portfolio).forEach(p => {
                p.avgBuyPrice = p.totalBuyCost / p.totalBuyQty;
            });

            let totalRealizedPL = 0;
            sellData.forEach(item => {
                const revenue = item.price * item.qty;
                totalSellRevenue += revenue;
                const asset = portfolio[item.ticker];
                if (asset) {
                    const realizedPL = (item.price - asset.avgBuyPrice) * item.qty;
                    asset.realizedPL += realizedPL;
                    asset.totalSellQty += item.qty;
                    asset.totalSellRevenue += revenue;
                    totalRealizedPL += realizedPL;
                }
            });

            let totalUnrealizedPL = 0;
            let finalReport = [];
            for (const ticker in portfolio) {
                const p = portfolio[ticker];
                p.ticker = ticker;
                p.currentPriceUSD = currentPrices[ticker] || 0; 
                
                // æ ¸å¿ƒæ›ç®—é‚è¼¯
                let conversionRate = 1;
                if (isUSStock(ticker)) {
                    conversionRate = exchangeRateUSDToTWD; 
                }
                
                p.currentPriceTWD = p.currentPriceUSD * conversionRate;
                p.avgBuyPriceTWD = p.avgBuyPrice; 
                
                p.remainingQty = p.totalBuyQty - p.totalSellQty;
                p.unrealizedPL = (p.currentPriceTWD - p.avgBuyPriceTWD) * p.remainingQty;
                totalUnrealizedPL += p.unrealizedPL;

                p.totalPL = p.realizedPL + p.unrealizedPL;
                p.roiPct = (p.totalBuyCost > 0) ? (p.totalPL / p.totalBuyCost) * 100 : 0;
                p.totalMarketValue = p.remainingQty * p.currentPriceTWD; 
                p.assetTypeLabel = getAssetTypeLabel(ticker);
                
                finalReport.push(p);
            }
            
            const totalPL = totalRealizedPL + totalUnrealizedPL;
            const totalROIPct = (totalBuyCost > 0) ? (totalPL / totalBuyCost) * 100 : 0;

            return {
                report: finalReport,
                dashboard: { totalBuyCost, totalSellRevenue, totalRealizedPL, totalUnrealizedPL, totalPL, totalROIPct }
            };
        }

        // --- 8. æ¸²æŸ“ç¸½è¡¨èˆ‡ Dashboard ---
        function renderReport() {
            if (buyData.length === 0) {
                document.querySelector('#portfolio-table tbody').innerHTML = '<tr><td colspan="11" style="text-align: center;">è«‹å…ˆè¼¸å…¥è²·å…¥ç´€éŒ„</td></tr>';
                document.getElementById('dashboard-output').innerHTML = 'è«‹è¼¸å…¥äº¤æ˜“ç´€éŒ„å¾Œé»æ“Šè¨ˆç®—';
                // æ¸…é™¤åœ–è¡¨
                if (currentCharts.holdingsPie) currentCharts.holdingsPie.destroy();
                if (currentCharts.plBar) currentCharts.plBar.destroy();
                if (currentCharts.roiBar) currentCharts.plBar.destroy();
                return;
            }

            const { report, dashboard } = calculatePortfolio();
            const tableBody = document.querySelector('#portfolio-table tbody');
            const dashboardOutput = document.getElementById('dashboard-output');

            let tableHTML = '';
            
            report.forEach(p => {
                const displayPrice = isUSStock(p.ticker) 
                    ? `${formatCurrency(p.currentPriceTWD)}<br>(USD ${formatCurrency(p.currentPriceUSD, 4)})`
                    : formatCurrency(p.currentPriceTWD, 4);

                tableHTML += `
                    <tr>
                        <td class="text-left">${p.ticker}</td>
                        <td>${p.assetTypeLabel}</td>
                        <td>${displayPrice}</td>
                        <td>${formatCurrency(p.totalBuyCost)}</td>
                        <td>${formatCurrency(p.avgBuyPriceTWD)}</td>
                        <td>${formatCurrency(p.totalSellRevenue)}</td>
                        <td>${formatPL(p.realizedPL)}</td>
                        <td>${p.remainingQty.toFixed(4)}</td>
                        <td>${formatPL(p.unrealizedPL)}</td>
                        <td>${formatPL(p.totalPL)}</td>
                        <td>${formatPL(p.roiPct)}%</td>
                    </tr>
                `;
            });
            tableBody.innerHTML = tableHTML;

            dashboardOutput.innerHTML = `
                <div class="dashboard-item">è³¼è²·ç¸½æˆæœ¬<div class="dashboard-value">${formatCurrency(dashboard.totalBuyCost)}</div></div>
                <div class="dashboard-item">å‡ºå”®ç¸½ç²åˆ©<div class="dashboard-value">${formatCurrency(dashboard.totalSellRevenue)}</div></div>
                <div class="dashboard-item">ç¸½å¯¦ç¾ç›ˆè™§<div class="dashboard-value">${formatPL(dashboard.totalRealizedPL)}</div></div>
                <div class="dashboard-item">ç¸½æµ®å‹•æç›Š<div class="dashboard-value">${formatPL(dashboard.totalUnrealizedPL)}</div></div>
                <div class="dashboard-item">ç¸½æç›Š<div class="dashboard-value">${formatPL(dashboard.totalPL)}</div></div>
                <div class="dashboard-item">ç¸½æŠ•è³‡å ±é…¬ç‡<div class="dashboard-value">${formatPL(dashboard.totalROIPct)}%</div></div>
            `;

            renderCharts(report);
        }
        
        // --- 9. åœ–è¡¨ç¹ªè£½å‡½æ•¸ (ä¿æŒä¸è®Š) ---
        function renderCharts(report) { 
            const holdings = report.filter(p => p.remainingQty > 0);
            const pieLabels = holdings.map(p => p.ticker);
            const pieData = holdings.map(p => p.totalMarketValue);

            const pieConfig = { type: 'pie', data: { labels: pieLabels, datasets: [{ data: pieData, backgroundColor: ['#42A5F5', '#66BB6A', '#FFA726', '#EF5350', '#7E57C2', '#26A69A'], }] }, options: { responsive: true, plugins: { legend: { position: 'top' } } } };
            if (currentCharts.holdingsPie) currentCharts.holdingsPie.destroy();
            const pieCtx = document.getElementById('holdingsPieChart').getContext('2d');
            currentCharts.holdingsPie = new Chart(pieCtx, pieConfig);

            const plLabels = report.map(p => p.ticker);
            const realizedPLData = report.map(p => p.realizedPL);
            const unrealizedPLData = report.map(p => p.unrealizedPL);

            const plConfig = { type: 'bar', data: { labels: plLabels, datasets: [{ label: 'å·²å¯¦ç¾æç›Š (Realized P/L)', data: realizedPLData, backgroundColor: 'rgba(75, 192, 192, 0.6)', }, { label: 'æœªå¯¦ç¾æç›Š (Unrealized P/L)', data: unrealizedPLData, backgroundColor: 'rgba(255, 159, 64, 0.6)', }] }, options: { responsive: true, scales: { y: { beginAtZero: false } } } };
            if (currentCharts.plBar) currentCharts.plBar.destroy();
            const plCtx = document.getElementById('plBarChart').getContext('2d');
            currentCharts.plBar = new Chart(plCtx, plConfig);

            
            const roiLabels = report.map(p => p.ticker);
            const roiData = report.map(p => p.roiPct);

            const roiConfig = { type: 'bar', data: { labels: roiLabels, datasets: [{ label: 'ç¸½æŠ•è³‡å ±é…¬ç‡ (%)', data: roiData, backgroundColor: roiData.map(val => val >= 0 ? '#66BB6A' : '#EF5350'), }] }, options: { responsive: true, scales: { y: { beginAtZero: false, title: { display: true, text: 'ROI (%)' } } } } };
            if (currentCharts.roiBar) currentCharts.roiBar.destroy();
            const roiCtx = document.getElementById('roiBarChart').getContext('2d');
            currentCharts.roiBar = new Chart(roiCtx, roiConfig);
        }
        
        // é é¢åˆæ¬¡è¼‰å…¥æ™‚
        window.onload = function() {
            loadData();
            // è¼‰å…¥åŒ¯ç‡ä¸¦é¡¯ç¤º
            document.getElementById('exchangeRateInput').value = exchangeRateUSDToTWD; 
            updatePriceInputList(); 
            renderTransactionList();
            renderReport();
        }
    </script>

</body>
</html>